---
date: "2016-04-27T00:00:00Z"
external_link: ""
image:
  focal_point: Smart
  preview_only: true
links:
summary: Null
title: "Question 2 for Agrochemical Scoping Project: How does daily temperature on orchards impact product performance?"
share: false
profile: false
comments: false
reading_time: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(kableExtra)
library(ggplot2)
library(tidyverse)
library(effects)
library(ecodatamisc)
demo_dat = read.csv("demo.csv")
demo_dat$response = as.factor(demo_dat$Product_success)
dat2 = subset(demo_dat,State=="California")
dat3 = subset(demo_dat,State=="Florida")

bg = "#1b2724"
wh = "#ffffff"
pl = "#6eb39c"
```

## Data sourcing

Our  client's team had a strong assumption that the local
weather conditions, especially high and low temperatures, would impact the
performance of their pesticide product.

End-user survey data provided by the client included GPS
coordinates for all farms and date of application, so we used that information
to pull from local weather stations located within a few miles. To do so, we
developed a pipeline that draws historical data based on latitude, longitude,
and Julian date to automatically provide the daily max temperature (highest
recorded temperature that day).

## Modeling info

We ran three models: overall performance, and performance broken down by state (California and Florida). Similar to in Question 1, these were binomial GLMs, but since
temperature is continuous, the figures appear different.

The simplest way to interpret these models is that steep, s-shaped curve is a
strong correlation, while a flatter curve is a weak correlation. Each dot
represents an observation from a farm (temperatures and a record of
product failure or success).

## What is the takeaway from the analysis of daily temperature?
#### Overall results
Product performance was impacted by higher temperatures (Figure 1).

```{r all}
mod1 = glm(response ~ Daily_high_temp, family=binomial, data=demo_dat)
eff1 = allEffects(se=TRUE, xlevels=100, mod=mod1) %>%
  as.data.frame()

ggplot(data=eff1$Daily_high_temp,aes(x=Daily_high_temp, y=fit))+
  geom_line(linewidth=1,colour=pl) +
  geom_ribbon(aes(ymin=fit-se, ymax=fit+se),alpha=.2,fill=pl) +
  labs(title = '', x = '\nDaily max temperature (F)', y = 'Probability of product success\n') +
  theme_ecodata() +
  theme(
    panel.background = element_rect(fill=bg, colour=NA),
    plot.background = element_rect(fill=bg, colour=NA),
    axis.line = element_line(colour=wh),
    axis.text = element_text(colour=wh),
    axis.title.x = element_text(colour=wh),
    axis.title.y = element_text(colour=wh),
    panel.border = element_rect(colour=wh,fill=NA)
  ) +
  geom_point(data=demo_dat, aes(x=Daily_high_temp, y=as.double(response)-1), position=position_jitter(w=0.05, h=0), alpha=.3, colour=pl)
```
(Figure 1: Good result combining the data)

Hot days may cause pesticide failure - on days that reach high maximum temperatures,
growers were more likely to report product failure. 

However there's still some scatter in the combined results. We sliced through the data in several other ways including altitude, crop species, [list some others]. However it was state that turned out to be key.

#### West coast results
You can see that in farms from California there is a strong 'S' shaped curve (Figure 2), indicating a sharp temperature threshold at 35.6C (XXF). If you look at the original data (cyan dots) in Figure 2, you can see that pesticide success only occurred twice once maximum daily temperature went over 35C (XXF).

```{r cali}
mod2 = glm(response ~ Daily_high_temp, family=binomial, data=dat2)
eff2 = allEffects(se=TRUE, xlevels=100, mod=mod2) %>%
  as.data.frame()

ggplot(data=eff2$Daily_high_temp,aes(x=Daily_high_temp, y=fit))+
  geom_line(linewidth=1,colour=pl) +
  geom_ribbon(aes(ymin=fit-se, ymax=fit+se),alpha=.2,fill=pl) +
  labs(title = '', x = '\nDaily max temperature (F)', y = 'Probability of product success\n') +
  theme_ecodata() +
  theme(
    panel.background = element_rect(fill=bg, colour=NA),
    plot.background = element_rect(fill=bg, colour=NA),
    axis.line = element_line(colour=wh),
    axis.text = element_text(colour=wh),
    axis.title.x = element_text(colour=wh),
    axis.title.y = element_text(colour=wh),
    panel.border = element_rect(colour=wh,fill=NA)
  ) +
  geom_point(data=dat2, aes(x=Daily_high_temp, y=as.double(response)-1), position=position_jitter(w=0.05, h=0), alpha=.3, colour=pl)
```
(Figure 2: Great result just focusing on California)

#### East coast results
However, Floridian farms produced a flatter curve (Figure 3), suggesting that temperature only weakly predicted product success or failure.

```{r fl}
mod3 = glm(response ~ Daily_high_temp, family=binomial, data=dat3)
eff3 = allEffects(se=TRUE, xlevels=100, mod=mod3) %>%
  as.data.frame()

ggplot(data=eff3$Daily_high_temp,aes(x=Daily_high_temp, y=fit))+
  geom_line(linewidth=1,colour=pl) +
  geom_ribbon(aes(ymin=fit-se, ymax=fit+se),alpha=.2,fill=pl) +
  labs(title = '', x = '\nDaily max temperature (F)', y = 'Probability of product success\n') +
  theme_ecodata() +
  theme(
    panel.background = element_rect(fill=bg, colour=NA),
    plot.background = element_rect(fill=bg, colour=NA),
    axis.line = element_line(colour=wh),
    axis.text = element_text(colour=wh),
    axis.title.x = element_text(colour=wh),
    axis.title.y = element_text(colour=wh),
    panel.border = element_rect(colour=wh,fill=NA)
  ) +
  geom_point(data=dat3, aes(x=Daily_high_temp, y=as.double(response)-1), position=position_jitter(w=0.05, h=0), alpha=.3, colour=pl)
```
(Figure 3: mediocre result from Florida)

This means there must be some other factor at play on the East Coast vs the West, which may be interacting with temperature.  By determining this unknown factor then we can pinpoint similar clear thresholds for end-users in Florida as well.

## Our take-home message

Given the key result in Figure 1, the best recommendation may be to avoid
using products on days with warm nights/mornings, especially on farms in California. However the pattern is less clear from farms in Florida. More investigation is definitely needed!
