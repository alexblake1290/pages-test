---
date: "2022-12-01T00:00:00Z"
external_link: ""
image:
  focal_point: Smart
  preview_only: true
links:
summary: Null
title: "How is agrochemical performance impacted by high temperatures in orchards?"
share: false
profile: false
comments: false
reading_time: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(kableExtra)
library(ggplot2)
library(tidyverse)
library(effects)
library(ecodatamisc)
demo_dat = read.csv("demo.csv")
demo_dat$response = as.factor(demo_dat$Product_success)
dat2 = subset(demo_dat,State=="California")
dat3 = subset(demo_dat,State=="Florida")

bg = "#1b2724"
wh = "#ffffff"
pl = "#6eb39c"
```

<style>
p.caption {
  font-size: 0.8em;
  padding: 0px 0px 40px 0px;
}
</style>

## Data sourcing

Our client suspected extraordinarily high and low temperatures would impact the performance of their agrochemical used in citrus.

Consumer survey data provided by the client included GPS coordinates for all orchards and date of application. Importantly, this included a record of when the product succeeded or failed (Figure 1).

```{r bar, fig.cap="Overall results from end-user survey on agrochemical success following product application."}
demo_dat %>%
  group_by(Product_success) %>%
  summarize(value = n()) %>%
  ggplot(aes(x = Product_success, y = value)) +
    geom_bar(stat = 'identity', fill = pl) +
    labs(title = '', x = '\nQuestion:\n\nWas the product effective?', y = 'Survey response count\n') +
    ylim(0,80) +
    theme_ecodata() +
    theme(
      panel.background = element_rect(fill=bg, colour=NA),
      plot.background = element_rect(fill=bg, colour=NA),
      axis.line = element_line(colour=wh),
      axis.text = element_text(colour=wh),
      axis.title.x = element_text(colour=wh),
      axis.title.y = element_text(colour=wh),
      panel.border = element_rect(colour=wh,fill=NA)
    )
```
<br>

To understand where the products were failing 25% of the time, we gathered data from local weather stations located within a few miles of each orchard.

To do so, we programmed a data pipeline that draws historical data based on latitude, longitude, and Julian date to automatically provide the daily max and min temperatures (highest and lowest recorded temperatures that day). Here's a snippet of what we did:

```{r code1, eval=FALSE, echo=TRUE}
ad <- ad_raw%>% 
  select(lat, lon, app_date = "App. date") %>%
  mutate(pre_date = app_date - 7) %>%
  mutate(across(c(pre_date, app_date), ~ as.character(.x))) %>%
  distinct(lat, lon, app_date, pre_date) %>%
  ungroup() %>%
  mutate(file_index = str_pad(as.character(1:n()), 2, "left", "0")) %>%
  mutate(id = str_pad(as.character(1:nrow(.)), 3, "left", "0")) # nearby station
```

## So what was the impact of daily temperature?
#### Overall results
Product performance was impacted by higher temperatures (Figure 2). There was no impact of minimum temperatures.

```{r all, fig.cap="Probability of agrochemical product success in response to daily maximum temperatures, across all farms. High temperatures significantly impacted product performance (p < 0.001). The product fell below the client's key success rate of 75% (horizontal line) once temperatures exceeded 80F. Each point represents a survey response. Shaded region indicates uncertainty: tighter shading indicates higher confidence."}
mod1 = glm(response ~ Daily_high_temp, family=binomial, data=demo_dat)
eff1 = allEffects(se=TRUE, xlevels=100, mod=mod1) %>%
  as.data.frame()

ggplot(data=eff1$Daily_high_temp,aes(x=Daily_high_temp, y=fit))+
  geom_line(linewidth=1,colour=pl) +
  geom_ribbon(aes(ymin=fit-se, ymax=fit+se),alpha=.2,fill=pl) +
  geom_hline(yintercept=0.75,colour=wh,linetype="dashed") +
  scale_y_continuous(labels=scales::percent) +
  labs(title = '', x = '\nDaily max. temp. (F)\n\nAll farms', y = 'Product success (%)\n') +
  theme_ecodata() +
  theme(
    panel.background = element_rect(fill=bg, colour=NA),
    plot.background = element_rect(fill=bg, colour=NA),
    axis.line = element_line(colour=wh),
    axis.text = element_text(colour=wh),
    axis.title.x = element_text(colour=wh),
    axis.title.y = element_text(colour=wh),
    panel.border = element_rect(colour=wh,fill=NA)
  ) +
  geom_point(data=demo_dat, aes(x=Daily_high_temp, y=as.double(response)-1), position=position_jitter(w=0.05, h=0), alpha=.3, colour=pl)
```
<br>

The simplest way to interpret these models is that a steep, S-shaped curve is a strong correlation between product performance and temperature. A flatter curve is a weak correlation. Each dot represents a piece of data collected in the consumer survey.

Our conclusion was clear. Hot days cause product failure - on days that reach high maximum temperatures, growers were more likely to report product failure. Failure starts at 80F and performance plummets shortly afterwards.

However, our client was concerned these results didn’t hold true in all locations. The climate of the two states surveyed vary by a lot more than just daily temperatures.

#### West coast results
You can see that in farms from California there is a strong ‘S’ shaped curve (Figure 3), indicating a sharp temperature threshold at 86F. We concluded that product recommendations should change in California and to tell growers to avoid using this agrochemical on hot days.

```{r cali, fig.cap="Probability of agrochemical product success in response to daily maximum temperatures on farms in California only. High temperatures significantly impacted product performance (p < 0.001). The product fell below the client's key success rate of 75% (horizontal line) once temperatures exceeded 86F. Each point represents a survey response. Shaded region indicates uncertainty: tighter shading indicates higher confidence."}
mod2 = glm(response ~ Daily_high_temp, family=binomial, data=dat2)
eff2 = allEffects(se=TRUE, xlevels=100, mod=mod2) %>%
  as.data.frame()

ggplot(data=eff2$Daily_high_temp,aes(x=Daily_high_temp, y=fit))+
  geom_line(linewidth=1,colour=pl) +
  geom_ribbon(aes(ymin=fit-se, ymax=fit+se),alpha=.2,fill=pl) +
  geom_hline(yintercept=0.75,colour=wh,linetype="dashed") +
  scale_y_continuous(labels=scales::percent) +
  labs(title = '', x = '\nDaily max. temp. (F)\n\nCalifornia', y = 'Product success (%)\n') +
  theme_ecodata() +
  theme(
    panel.background = element_rect(fill=bg, colour=NA),
    plot.background = element_rect(fill=bg, colour=NA),
    axis.line = element_line(colour=wh),
    axis.text = element_text(colour=wh),
    axis.title.x = element_text(colour=wh),
    axis.title.y = element_text(colour=wh),
    panel.border = element_rect(colour=wh,fill=NA)
  ) +
  geom_point(data=dat2, aes(x=Daily_high_temp, y=as.double(response)-1), position=position_jitter(w=0.05, h=0), alpha=.3, colour=pl)
```

#### East coast results
However, Floridian farms produced a flatter curve (Figure 3), suggesting that temperature only weakly predicted product success or failure. Something else was causing product failure in this region.

```{r fl, fig.cap="Probability of agrochemical product success in response to daily maximum temperatures on farms in Florida only. Here we found no strong statistical impact of temperature on agrochemical performance (p = 0.82), with product success rate steady at around 75%. Each point represents a survey response. Shaded region indicates uncertainty: tighter shading indicates higher confidence."}
mod3 = glm(response ~ Daily_high_temp, family=binomial, data=dat3)
eff3 = allEffects(se=TRUE, xlevels=100, mod=mod3) %>%
  as.data.frame()

ggplot(data=eff3$Daily_high_temp,aes(x=Daily_high_temp, y=fit))+
  geom_line(linewidth=1,colour=pl) +
  geom_ribbon(aes(ymin=fit-se, ymax=fit+se),alpha=.2,fill=pl) +
  scale_y_continuous(labels=scales::percent) +
  labs(title = '', x = '\nDaily max. temp. (F)\n\nFlorida', y = 'Product success (%)\n') +
  theme_ecodata() +
  theme(
    panel.background = element_rect(fill=bg, colour=NA),
    plot.background = element_rect(fill=bg, colour=NA),
    axis.line = element_line(colour=wh),
    axis.text = element_text(colour=wh),
    axis.title.x = element_text(colour=wh),
    axis.title.y = element_text(colour=wh),
    panel.border = element_rect(colour=wh,fill=NA)
  ) +
  geom_point(data=dat3, aes(x=Daily_high_temp, y=as.double(response)-1), position=position_jitter(w=0.05, h=0), alpha=.3, colour=pl)
```

## Our take-home message

We helped our client make regionally-tailored product recommendations and pinpointed the cause (high temperatures). California citrus orchards changed the agrochemical usage guidelines, and the client is now working with us to investigate what may be mitigating temperature effects and causing 25% failure in Florida citrus orchards.

#### What's next?
We are working with the client to follow their next hunch: cloudy weather might also be responsible for product failure.

Cloud cover data is difficult to extract due to its complexity and density. Large-scale data warehouses include satellite photographs of land surfaces (LandSat program with NASA/USGS), which includes billions of rows of data. The hard part isn’t analyzing the data – its *finding* it.

For this project, we are developing a pipeline to pull all photographs in a 1-5km buffer around surveyed farms. Our team is now organizing data and warehousing it for future modeling efforts. Check out a sample below:

```{r code2, eval=FALSE, echo=TRUE}
# function to fetch cloud cover data
get_cc <- function(buffer) {
  
  recs <- get_records(
                 time_range = as.character(c(buffer$app_date - 7, buffer$app_date)), 
                 products = get_cloudcov_supported()[5:6], # Sentinel
                 aoi = buffer$geometry, 
                 as_sf = FALSE)
  clouds <- calc_cloudcov(recs, aoi = buffer$geometry, 
                          write_records = FALSE, write_cloud_masks = FALSE, 
                          dir_out = "data/cloud-cover/")
  
  clouds %>%
    write_csv(file = paste0("data/cover-dfs-new/", buffer$id, "_cloud_cover.csv"))
}
```

<img src="orchard.jpeg" style="border-radius: 5%;" />